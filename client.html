<!doctype html>
<html>
  <head><meta charset="utf-8"></head>
  <body>
    <h1>My Cool WebSocket Client</h1>
    <img src="http://www.theoklahomakid.com/images/fire-under-construction-animation_1_.gif"/>
    <script type="text/javascript" src="file:///C:/Projects/docker-guttest/FileSaver.js"></script>
    <script>
      let doit = true; // Temporary dev flag to toggle sending the array
      let imagelist = []; // This will be sent to the server via WebSocket

      function randomIntFromInterval(min, max) {
        return Math.floor(Math.random() * (max - min + 1) + min);
      }
      
      // Generate some psuedo-random image sets so we get diff zips on retries
      let last3 = randomIntFromInterval(200,900);
      for(let i = 10; i > 0; i--) {
        last3 = last3 - i;
        let str = `https://retailerservices.diamondcomics.com/Image/ItemMainImageLowRes/STL060${last3}.jpg`;
        imagelist.push(str);
      }

      // Connect with server
      let websock = new WebSocket('ws://localhost:8011');
      websock.binaryType = "blob";
      websock.onopen = function(event) {
        console.log("WebSocket is now open.");
        websock.send("Is there anybody out there?");
        if (doit) {
          websock.send(JSON.stringify(imagelist));
        } else {
          websock.send("Holding.");
        }
      };

      websock.onmessage = function(msg) {
        if (msg.data instanceof Blob) {
          console.log("Client Data: Blob incoming...");
          reader = new FileReader(); // TODO: Do I even need this reader? ...
          reader.onload = () => {
            saveAs(msg.data, "plzwork.zip");
          };
          reader.readAsArrayBuffer(msg.data);
        } else {
          console.log("Client received: ", msg.data);
        }
      };
    </script>
  </body>
</html>
